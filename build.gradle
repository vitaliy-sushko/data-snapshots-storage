plugins {
    id 'java'
    id 'idea'
    id 'application'
    id 'groovy'
    id 'org.springframework.boot' version '2.4.2'
    id 'io.spring.dependency-management' version '1.0.11.RELEASE'
    id 'org.unbroken-dome.test-sets' version '3.0.1'
    id 'jacoco'
    id "org.sonarqube" version "3.1"
}

repositories {
    mavenCentral()
    jcenter()
}

sourceSets {
    integrationTest {
        groovy.srcDir file('src/integrationTest/groovy')
        resources.srcDir file('src/integrationTest/resources')
        compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath
        runtimeClasspath += output + compileClasspath
    }
}

sourceCompatibility = JavaVersion.VERSION_11
targetCompatibility = JavaVersion.VERSION_11

mainClassName = 'com.example.data.snapshots.storage.SnapshotStorageApp'
version = '0.0.3'

ext['slf4j.version'] = '1.7.30'
ext {
    spockVersion = '1.3-groovy-2.5'
    guavaVersion = '30.1-jre'
    groovyVersion = '3.0.7'
    junitVersion = '4.13.1'
    embedResdisVersion = '0.6'
    jedisVersion = '3.4.1'
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation "com.google.guava:guava:$guavaVersion"
    implementation 'org.hibernate.validator:hibernate-validator'
    implementation "com.fasterxml.jackson.dataformat:jackson-dataformat-csv"
    implementation "com.fasterxml.jackson.datatype:jackson-datatype-jdk8"
    implementation "redis.clients:jedis:$jedisVersion"
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation "org.codehaus.groovy:groovy-all:$groovyVersion"
    testImplementation "org.spockframework:spock-core:$spockVersion"
    testImplementation "org.spockframework:spock-spring:$spockVersion"
    testImplementation "junit:junit:$junitVersion"
    testImplementation "com.github.kstyrc:embedded-redis:$embedResdisVersion"
}

task integrationTest(type: Test) {
    description = 'Runs the integration tests.'
    group = 'verification'
    testClassesDirs = sourceSets.integrationTest.output.classesDirs
    classpath = sourceSets.integrationTest.runtimeClasspath
    outputs.upToDateWhen { false }
    mustRunAfter test
    jacoco {
        destinationFile = file("$buildDir/jacoco/integrationTest.exec")
    }
}

check.dependsOn integrationTest

idea {
    module {
        testSourceDirs += sourceSets.integrationTest.groovy.srcDirs
        testResourceDirs += sourceSets.integrationTest.resources.srcDirs
        scopes.TEST.plus += [configurations.integrationTestCompile]
    }
}

tasks.withType(Test) {
    reports.html.destination = file("${reporting.baseDir}/${name}")
}

jacoco {
    toolVersion = "0.8.3"
}

jacocoTestReport {
    reports {
        xml.enabled true
    }
    sourceSets sourceSets.main
    executionData fileTree(project.rootDir.absolutePath).include("**/build/jacoco/*.exec")
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                    'com/example/data/snapshots/storage/config/**/*',
                    'com/example/data/snapshots/storage/model/**',
                    'com/example/data/snapshots/storage/SnapshotStorageApp.*'
            ])
        }))
    }
}

sonarqube {
    properties {
        property "sonar.projectKey", "data-snapshot-storage"
        property "sonar.organization", "snapshot-storage"
        property "sonar.host.url", "https://sonarcloud.io"
        property "sonar.projectName", "data-snapshots-storage"
        property "sonar.java.coveragePlugin", "jacoco"
        properties['sonar.junit.reportsPath'] += "build/test-results/test"
        properties['sonar.junit.reportsPath'] += "build/test-results/integrationTest"
        properties['sonar.sources'] = sourceSets.main.java.srcDirs
        properties['sonar.sources'] += sourceSets.main.resources.srcDirs
        properties['sonar.tests'] += sourceSets.integrationTest.groovy.srcDirs
        properties['sonar.tests'] += sourceSets.integrationTest.resources.srcDirs
        property "sonar.coverage.exclusions", "**/*Generated.*, **/com/example/data/snapshots/storage/config/**/*, **/com/example/data/snapshots/storage/model/*, **/com/example/data/snapshots/storage/SnapshotStorageApp.*"
    }
}

test {
    useJUnit {
        includeCategories 'com.example.data.snapshots.storage.UnitTest'
    }
    testLogging {
        showStandardStreams = true
    }
}

integrationTest {
    useJUnit {
        includeCategories 'com.example.data.snapshots.storage.IntegrationTest'
    }
    testLogging {
        showStandardStreams = true
    }
}
